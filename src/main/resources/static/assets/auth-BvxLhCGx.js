var e=Object.defineProperty,t=(t,r,n)=>((t,r,n)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[r]=n)(t,"symbol"!=typeof r?r+"":r,n),r=(e,t,r)=>new Promise((n,o)=>{var s=e=>{try{a(r.next(e))}catch(t){o(t)}},i=e=>{try{a(r.throw(e))}catch(t){o(t)}},a=e=>e.done?n(e.value):Promise.resolve(e.value).then(s,i);a((r=r.apply(e,t)).next())});import{a as n}from"./utils-D3YFsgXT.js";import"./vendor-Cb5iQNse.js";import"./react-vendor-DxVTcXnD.js";import"./state-management-DszUOxv_.js";const o="http://localhost:8080";class s extends Error{constructor(e,t,r,n){super(r),this.status=e,this.code=t,this.details=n,this.name="ApiError"}}const i=new class{constructor(){t(this,"client"),t(this,"tokenRefreshPromise",null),this.client=n.create({baseURL:o,timeout:1e4,headers:{"Content-Type":"application/json"}}),this.setupInterceptors()}setupInterceptors(){this.client.interceptors.request.use(e=>{const t=this.getStoredToken();return t&&e.headers&&(e.headers.Authorization=`Bearer ${t}`),e},e=>Promise.reject(e)),this.client.interceptors.response.use(e=>e,e=>r(this,null,function*(){var t;const r=e.config;if(401===(null==(t=e.response)?void 0:t.status)&&!r._retry){r._retry=!0;try{const e=yield this.refreshAccessToken();return r.headers&&(r.headers.Authorization=`Bearer ${e}`),this.client(r)}catch(n){return this.clearStoredTokens(),window.location.href="/login",Promise.reject(n)}}return Promise.reject(this.handleApiError(e))}))}handleApiError(e){if(e.response){const{status:t,data:r}=e.response,n=r;return new s(t,(null==n?void 0:n.code)||"UNKNOWN_ERROR",(null==n?void 0:n.message)||e.message,n)}return e.request?new s(0,"NETWORK_ERROR","Please check your network connection."):new s(0,"REQUEST_ERROR",e.message)}getStoredToken(){try{return localStorage.getItem("accessToken")}catch(e){return null}}getStoredRefreshToken(){try{return localStorage.getItem("refreshToken")}catch(e){return null}}storeTokens(e,t){try{localStorage.setItem("accessToken",e),localStorage.setItem("refreshToken",t)}catch(r){}}clearStoredTokens(){try{localStorage.removeItem("accessToken"),localStorage.removeItem("refreshToken"),localStorage.removeItem("user")}catch(e){}}refreshAccessToken(){return r(this,null,function*(){return this.tokenRefreshPromise||(this.tokenRefreshPromise=(()=>r(this,null,function*(){try{const e=this.getStoredRefreshToken();if(!e)throw new Error("No refresh token available.");const t=yield n.post(`${o}/api/auth/refresh`,{refreshToken:e}),{accessToken:r,refreshToken:s}=t.data;return this.storeTokens(r,s),r}finally{this.tokenRefreshPromise=null}}))()),this.tokenRefreshPromise})}login(e){return r(this,null,function*(){const t=yield this.client.post("/api/auth/login",e),{accessToken:r,refreshToken:n}=t.data;return this.storeTokens(r,n),t.data})}register(e){return r(this,null,function*(){const t=yield this.client.post("/api/auth/register",e),{accessToken:r,refreshToken:n}=t.data;return this.storeTokens(r,n),t.data})}logout(){return r(this,null,function*(){try{yield this.client.post("/api/auth/logout")}catch(e){}finally{this.clearStoredTokens()}})}checkEmailAvailability(e){return r(this,null,function*(){return(yield this.client.get(`/api/auth/check-email?email=${encodeURIComponent(e)}`)).data.available})}sendPhoneVerification(e){return r(this,null,function*(){yield this.client.post("/api/auth/send-verification",{phoneNumber:e})})}verifyPhoneCode(e,t){return r(this,null,function*(){return(yield this.client.post("/api/auth/verify-code",{phoneNumber:e,code:t})).data.valid})}forgotPassword(e){return r(this,null,function*(){yield this.client.post("/api/auth/forgot-password",{email:e})})}validateResetToken(e,t){return r(this,null,function*(){return(yield this.client.post("/api/auth/validate-reset-token",{token:e,email:t})).data.valid})}resetPassword(e){return r(this,null,function*(){yield this.client.post("/api/auth/reset-password",e)})}getProfile(){return r(this,null,function*(){return(yield this.client.get("/api/auth/profile")).data})}validateToken(){return r(this,null,function*(){try{const e=this.getStoredToken();if(!e)return!1;return(yield this.client.post("/api/auth/validate",{token:e})).data.valid}catch(e){return!1}})}getSocialLoginUrl(e,t){const r=new URLSearchParams;return t&&r.append("redirect",t),`${o}/api/auth/oauth/${e}?${r.toString()}`}handleSocialCallback(e,t){return r(this,null,function*(){const r=yield this.client.post("/api/auth/oauth/callback",{code:e,provider:t}),{accessToken:n,refreshToken:o}=r.data;return this.storeTokens(n,o),r.data})}},a=e=>i.login(e),l=e=>i.register(e),c=()=>i.logout(),h=()=>i.validateToken();export{s as ApiError,i as default,a as login,c as logout,l as register,h as validateToken};

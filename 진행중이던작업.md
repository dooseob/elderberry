     ☒ Phase 5-A 로깅 시스템 활용 확인 및 문서화
     ☐ Phase 5-B: 시설 매칭 및 추천 시스템 구현
     ☐ Phase 5-C: React 시설 검색 UI 구현
     ☐ Phase 6-A: 공공데이터 API 연동 기본 구현

● 🚀 Phase 5-B: 시설 매칭 및 추천 시스템 고도화

  Phase 5-A에서 기본 매칭 시스템을 구현했으므로, Phase 5-B에서는 AI 기반 지능형 매칭, 실시간 추천 시스템, 매칭 성과 추적 기능을 추가로
  구현하겠습니다.

  1️⃣ 지능형 매칭 성과 추적 시스템

● Write(src/main/java/com/globalcarelink/facility/FacilityMatchingHistory.java)
  ⎿  Wrote 222 lines to src/main/java/com/globalcarelink/facility/FacilityMatchingHistory.java
     package com.globalcarelink.facility;
     import com.globalcarelink.common.entity.BaseEntity;
     import jakarta.persistence.*;
     import jakarta.validation.constraints.*;
     import lombok.*;
     import java.math.BigDecimal;
     import java.time.LocalDateTime;
     … +212 lines (ctrl+r to expand)

● 2️⃣ 매칭 이력 저장소

● Write(src/main/java/com/globalcarelink/facility/FacilityMatchingHistoryRepository.java)
  ⎿  Wrote 237 lines to src/main/java/com/globalcarelink/facility/FacilityMatchingHistoryRepository.java
     package com.globalcarelink.facility;
     import org.springframework.data.domain.Page;
     import org.springframework.data.domain.Pageable;
     import org.springframework.data.jpa.repository.JpaRepository;
     import org.springframework.data.jpa.repository.Query;
     import org.springframework.data.repository.query.Param;
     import org.springframework.stereotype.Repository;
     import java.math.BigDecimal;
     … +227 lines (ctrl+r to expand)

● 3️⃣ 지능형 매칭 분석 서비스

● Write(src/main/java/com/globalcarelink/facility/FacilityMatchingAnalyticsService.java)
  ⎿  Wrote 516 lines to src/main/java/com/globalcarelink/facility/FacilityMatchingAnalyticsService.java
     package com.globalcarelink.facility;
     import lombok.*;
     import lombok.extern.slf4j.Slf4j;
     import org.springframework.cache.annotation.Cacheable;
     import org.springframework.data.domain.Page;
     import org.springframework.data.domain.PageRequest;
     import org.springframework.scheduling.annotation.Async;
     import org.springframework.stereotype.Service;
     import org.springframework.transaction.annotation.Transactional;
     … +506 lines (ctrl+r to expand)

● 4️⃣ 고도화된 매칭 서비스 업데이트

● Read(src/main/java/com/globalcarelink/facility/FacilityProfileService.java)
  ⎿  Read 50 lines (ctrl+r to expand)

● Update(src/main/java/com/globalcarelink/facility/FacilityProfileService.java)
  ⎿  Updated src/main/java/com/globalcarelink/facility/FacilityProfileService.java with 1 addition
       30    public class FacilityProfileService {
       31    
       32        private final FacilityProfileRepository facilityProfileRepository;
       33 +      private final FacilityMatchingHistoryRepository matchingHistoryRepository;       
       34    
       35        // ===== 기본 CRUD 작업 =====
       36    

● Read(src/main/java/com/globalcarelink/facility/FacilityProfileService.java)
  ⎿  Read 25 lines (ctrl+r to expand)

● Read(src/main/java/com/globalcarelink/facility/FacilityProfileService.java)
  ⎿  Read 50 lines (ctrl+r to expand)

● Read(src/main/java/com/globalcarelink/facility/FacilityProfileService.java)
  ⎿  Read 0 lines

● Update(src/main/java/com/globalcarelink/facility/FacilityProfileService.java)
  ⎿  Error: String to replace not found in file.
     String:         return Math.min(score, 5.0);
         }

         // ===== 공통 유틸리티 메서드 =====

● Read(src/main/java/com/globalcarelink/facility/FacilityProfileService.java)
  ⎿  Read 26 lines (ctrl+r to expand)

● Update(src/main/java/com/globalcarelink/facility/FacilityProfileService.java)
  ⎿  Updated src/main/java/com/globalcarelink/facility/FacilityProfileService.java with 261 additions
        872            private final Map<String, Long> gradeStatistics;
        873            private final LocalDateTime lastUpdated;
        874        }
        875 +  
        876 +      // ===== 매칭 이력 추적 =====
        877 +  
        878 +      /**
        879 +       * 매칭 추천 결과를 이력에 저장
        880 +       */
        881 +      @Transactional
        882 +      public void recordMatchingRecommendations(String userId, String coordinatorId, 
        883 +                                              List<FacilityRecommendation> recommendations,
        884 +                                              HealthAssessment assessment, 
        885 +                                              FacilityMatchingPreference preference) {
        886 +          log.info("매칭 추천 이력 저장 - 사용자: {}, 추천 수: {}", userId, recommendations.size());
        887 +
        888 +          for (int i = 0; i < recommendations.size(); i++) {
        889 +              FacilityRecommendation recommendation = recommendations.get(i);
        890 +
        891 +              FacilityMatchingHistory history = FacilityMatchingHistory.builder()
        892 +                  .userId(userId)
        893 +                  .facilityId(recommendation.getFacility().getId())
        894 +                  .coordinatorId(coordinatorId)
        895 +                  .initialMatchScore(BigDecimal.valueOf(recommendation.getMatchScore()).setScale(2, 
            + java.math.RoundingMode.HALF_UP))
        896 +                  .recommendationRank(i + 1)
        897 +                  .matchingCriteria(serializeMatchingCriteria(assessment, preference))
        898 +                  .facilitySnapshot(serializeFacilitySnapshot(recommendation.getFacility()))
        899 +                  .estimatedCost(calculateEstimatedMonthlyCost(recommendation.getFacility(), assessment))
        900 +                  .build();
        901 +
        902 +              matchingHistoryRepository.save(history);
        903 +          }
        904 +
        905 +          log.info("매칭 추천 이력 저장 완료 - {} 건", recommendations.size());
        906 +      }
        907 +  
        908 +      /**
        909 +       * 사용자 행동 추적 - 시설 조회
        910 +       */
        911 +      @Transactional
        912 +      public void trackFacilityView(String userId, Long facilityId) {
        913 +          Optional<FacilityMatchingHistory> historyOpt = 
        914 +              matchingHistoryRepository.findTopByUserIdAndFacilityIdOrderByCreatedAtDesc(userId, facilityId);
        915 +
        916 +          if (historyOpt.isPresent()) {
        917 +              FacilityMatchingHistory history = historyOpt.get();
        918 +              history.markAsViewed();
        919 +              matchingHistoryRepository.save(history);
        920 +
        921 +              log.info("시설 조회 추적 완료 - 사용자: {}, 시설: {}", userId, facilityId);
        922 +          }
        923 +      }
        924 +  
        925 +      /**
        926 +       * 사용자 행동 추적 - 시설 연락
        927 +       */
        928 +      @Transactional
        929 +      public void trackFacilityContact(String userId, Long facilityId) {
        930 +          Optional<FacilityMatchingHistory> historyOpt = 
        931 +              matchingHistoryRepository.findTopByUserIdAndFacilityIdOrderByCreatedAtDesc(userId, facilityId);
        932 +
        933 +          if (historyOpt.isPresent()) {
        934 +              FacilityMatchingHistory history = historyOpt.get();
        935 +              history.markAsContracted();
        936 +              matchingHistoryRepository.save(history);
        937 +
        938 +              log.info("시설 연락 추적 완료 - 사용자: {}, 시설: {}", userId, facilityId);
        939 +          }
        940 +      }
        941 +  
        942 +      /**
        943 +       * 사용자 행동 추적 - 시설 방문
        944 +       */
        945 +      @Transactional
        946 +      public void trackFacilityVisit(String userId, Long facilityId) {
        947 +          Optional<FacilityMatchingHistory> historyOpt = 
        948 +              matchingHistoryRepository.findTopByUserIdAndFacilityIdOrderByCreatedAtDesc(userId, facilityId);
        949 +
        950 +          if (historyOpt.isPresent()) {
        951 +              FacilityMatchingHistory history = historyOpt.get();
        952 +              history.markAsVisited();
        953 +              matchingHistoryRepository.save(history);
        954 +
        955 +              log.info("시설 방문 추적 완료 - 사용자: {}, 시설: {}", userId, facilityId);
        956 +          }
        957 +      }
        958 +  
        959 +      /**
        960 +       * 매칭 완료 처리
        961 +       */
        962 +      @Transactional
        963 +      public void completeMatching(String userId, Long facilityId, 
        964 +                                 FacilityMatchingHistory.MatchingOutcome outcome,
        965 +                                 BigDecimal actualCost, BigDecimal satisfactionScore, String feedback) {
        966 +          Optional<FacilityMatchingHistory> historyOpt = 
        967 +              matchingHistoryRepository.findTopByUserIdAndFacilityIdOrderByCreatedAtDesc(userId, facilityId);
        968 +
        969 +          if (historyOpt.isPresent()) {
        970 +              FacilityMatchingHistory history = historyOpt.get();
        971 +              history.markAsSelected(outcome);
        972 +
        973 +              if (actualCost != null) {
        974 +                  history.setActualCost(actualCost);
        975 +              }
        976 +
        977 +              if (satisfactionScore != null) {
        978 +                  history.updateFeedback(satisfactionScore, feedback);
        979 +              }
        980 +
        981 +              matchingHistoryRepository.save(history);
        982 +
        983 +              log.info("매칭 완료 처리 - 사용자: {}, 시설: {}, 결과: {}", userId, facilityId, outcome);
        984 +          }
        985 +      }
        986 +  
        987 +      /**
        988 +       * 학습 기반 매칭 점수 조정
        989 +       */
        990 +      public List<FacilityRecommendation> adjustMatchingScoresWithLearning(List<FacilityRecommendation> recommendations,       
        991 +                                                                          String userId) {
        992 +          // 사용자의 과거 매칭 이력을 기반으로 점수 조정
        993 +          List<FacilityMatchingHistory> userHistory = 
        994 +              matchingHistoryRepository.findByUserIdOrderByCreatedAtDesc(userId);
        995 +
        996 +          if (userHistory.isEmpty()) {
        997 +              return recommendations; // 이력이 없으면 원본 그대로 반환
        998 +          }
        999 +
       1000 +          // 성공한 매칭들의 패턴 분석
       1001 +          List<FacilityMatchingHistory> successfulMatches = userHistory.stream()
       1002 +              .filter(FacilityMatchingHistory::isSuccessfulMatch)
       1003 +              .collect(Collectors.toList());
       1004 +
       1005 +          if (successfulMatches.isEmpty()) {
       1006 +              return recommendations;
       1007 +          }
       1008 +
       1009 +          // 선호 패턴 추출
       1010 +          Map<String, Double> facilityTypePreference = extractFacilityTypePreference(successfulMatches);
       1011 +          Map<String, Double> facilityGradePreference = extractFacilityGradePreference(successfulMatches);
       1012 +          double avgSuccessfulCost = calculateAverageSuccessfulCost(successfulMatches);
       1013 +
       1014 +          // 추천 점수 조정
       1015 +          return recommendations.stream()
       1016 +              .map(rec -> adjustRecommendationScore(rec, facilityTypePreference, facilityGradePreference, 
            + avgSuccessfulCost))
       1017 +              .sorted(Comparator.comparing(FacilityRecommendation::getMatchScore).reversed())
       1018 +              .collect(Collectors.toList());
       1019 +      }
       1020 +  
       1021 +      // ===== 학습 기반 유틸리티 메서드 =====
       1022 +  
       1023 +      private String serializeMatchingCriteria(HealthAssessment assessment, FacilityMatchingPreference preference) {
       1024 +          return String.format("{\"careGrade\":%d,\"regions\":%s,\"maxFee\":%d}", 
       1025 +              assessment.getCareGradeLevel(),
       1026 +              preference.getPreferredRegions().toString(),
       1027 +              preference.getMaxMonthlyFee() != null ? preference.getMaxMonthlyFee() : 0);
       1028 +      }
       1029 +  
       1030 +      private String serializeFacilitySnapshot(FacilityProfile facility) {
       1031 +          return String.format("{\"type\":\"%s\",\"grade\":\"%s\",\"capacity\":%d,\"monthlyFee\":%d}",
       1032 +              facility.getFacilityType(),
       1033 +              facility.getFacilityGrade(),
       1034 +              facility.getTotalCapacity(),
       1035 +              facility.getMonthlyBasicFee() != null ? facility.getMonthlyBasicFee() : 0);
       1036 +      }
       1037 +  
       1038 +      private BigDecimal calculateEstimatedMonthlyCost(FacilityProfile facility, HealthAssessment assessment) {
       1039 +          Integer basicFee = facility.getMonthlyBasicFee();
       1040 +          if (basicFee == null) return null;
       1041 +
       1042 +          double multiplier = 1.0;
       1043 +
       1044 +          // 케어 등급에 따른 비용 조정
       1045 +          if (assessment.getCareGradeLevel() <= 2) {
       1046 +              multiplier += 0.3; // 중증 케어 30% 추가
       1047 +          } else if (assessment.getCareGradeLevel() <= 3) {
       1048 +              multiplier += 0.15; // 중등도 케어 15% 추가
       1049 +          }
       1050 +
       1051 +          return BigDecimal.valueOf(basicFee * multiplier).setScale(0, java.math.RoundingMode.HALF_UP);
       1052 +      }
       1053 +  
       1054 +      private Map<String, Double> extractFacilityTypePreference(List<FacilityMatchingHistory> successfulMatches) {
       1055 +          Map<String, Double> preferences = new HashMap<>();
       1056 +
       1057 +          successfulMatches.forEach(match -> {
       1058 +              // 실제 구현에서는 시설 정보를 조회하여 타입을 확인
       1059 +              // 여기서는 간단히 처리
       1060 +              Optional<FacilityProfile> facility = facilityProfileRepository.findById(match.getFacilityId());
       1061 +              if (facility.isPresent()) {
       1062 +                  String type = facility.get().getFacilityType();
       1063 +                  preferences.merge(type, 1.0, Double::sum);
       1064 +              }
       1065 +          });
       1066 +
       1067 +          // 정규화
       1068 +          double total = preferences.values().stream().mapToDouble(Double::doubleValue).sum();
       1069 +          if (total > 0) {
       1070 +              preferences.replaceAll((k, v) -> v / total);
       1071 +          }
       1072 +
       1073 +          return preferences;
       1074 +      }
       1075 +  
       1076 +      private Map<String, Double> extractFacilityGradePreference(List<FacilityMatchingHistory> successfulMatches) {
       1077 +          Map<String, Double> preferences = new HashMap<>();
       1078 +
       1079 +          successfulMatches.forEach(match -> {
       1080 +              Optional<FacilityProfile> facility = facilityProfileRepository.findById(match.getFacilityId());
       1081 +              if (facility.isPresent()) {
       1082 +                  String grade = facility.get().getFacilityGrade();
       1083 +                  preferences.merge(grade, 1.0, Double::sum);
       1084 +              }
       1085 +          });
       1086 +
       1087 +          // 정규화
       1088 +          double total = preferences.values().stream().mapToDouble(Double::doubleValue).sum();
       1089 +          if (total > 0) {
       1090 +              preferences.replaceAll((k, v) -> v / total);
       1091 +          }
       1092 +
       1093 +          return preferences;
       1094 +      }
       1095 +  
       1096 +      private double calculateAverageSuccessfulCost(List<FacilityMatchingHistory> successfulMatches) {
       1097 +          return successfulMatches.stream()
       1098 +              .filter(match -> match.getActualCost() != null)
       1099 +              .mapToDouble(match -> match.getActualCost().doubleValue())
       1100 +              .average()
       1101 +              .orElse(0.0);
       1102 +      }
       1103 +  
       1104 +      private FacilityRecommendation adjustRecommendationScore(FacilityRecommendation recommendation,
       1105 +                                                             Map<String, Double> typePreference,
       1106 +                                                             Map<String, Double> gradePreference,
       1107 +                                                             double avgSuccessfulCost) {
       1108 +          double currentScore = recommendation.getMatchScore();
       1109 +          double adjustmentFactor = 1.0;
       1110 +
       1111 +          FacilityProfile facility = recommendation.getFacility();
       1112 +
       1113 +          // 시설 타입 선호도 반영
       1114 +          Double typeBonus = typePreference.get(facility.getFacilityType());
       1115 +          if (typeBonus != null) {
       1116 +              adjustmentFactor += typeBonus * 0.2; // 최대 20% 가산
       1117 +          }
       1118 +
       1119 +          // 시설 등급 선호도 반영
       1120 +          Double gradeBonus = gradePreference.get(facility.getFacilityGrade());
       1121 +          if (gradeBonus != null) {
       1122 +              adjustmentFactor += gradeBonus * 0.15; // 최대 15% 가산
       1123 +          }
       1124 +
       1125 +          // 비용 유사성 반영
       1126 +          if (avgSuccessfulCost > 0 && facility.getMonthlyBasicFee() != null) {
       1127 +              double costSimilarity = 1.0 - Math.abs(facility.getMonthlyBasicFee() - avgSuccessfulCost) / 
            + avgSuccessfulCost;
       1128 +              adjustmentFactor += Math.max(0, costSimilarity) * 0.1; // 최대 10% 가산
       1129 +          }
       1130 +
       1131 +          double adjustedScore = Math.min(currentScore * adjustmentFactor, 100.0);
       1132 +
       1133 +          return new FacilityRecommendation(facility, adjustedScore, 
       1134 +              recommendation.getRecommendationReason() + " (학습 기반 조정 적용)");
       1135 +      }
       1136    }
       1137   \ No newline at end of file
const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/auth-BvxLhCGx.js","assets/utils-D3YFsgXT.js","assets/vendor-Cb5iQNse.js","assets/react-vendor-DxVTcXnD.js","assets/state-management-DszUOxv_.js"])))=>i.map(i=>d[i]);
var e=Object.defineProperty,r=Object.defineProperties,t=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,l=(r,t,o)=>t in r?e(r,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):r[t]=o,s=(e,r)=>{for(var t in r||(r={}))n.call(r,t)&&l(e,t,r[t]);if(o)for(var t of o(r))a.call(r,t)&&l(e,t,r[t]);return e},i=(e,r,t)=>new Promise((o,n)=>{var a=e=>{try{s(t.next(e))}catch(r){n(r)}},l=e=>{try{s(t.throw(e))}catch(r){n(r)}},s=e=>e.done?o(e.value):Promise.resolve(e.value).then(a,l);s((t=t.apply(e,r)).next())});import{_ as c}from"./index-D5N1MR7h.js";import{s as u,p as d,i as h}from"./state-management-DszUOxv_.js";import{c as f}from"./react-vendor-DxVTcXnD.js";const g={user:null,accessToken:null,refreshToken:null,isAuthenticated:!1,isLoading:!1,error:null},y=()=>{try{return localStorage.getItem("accessToken")}catch(e){return null}},m=()=>{try{return localStorage.getItem("refreshToken")}catch(e){return null}},T=(e,r)=>{try{localStorage.setItem("accessToken",e),localStorage.setItem("refreshToken",r)}catch(t){}},p=()=>{try{localStorage.removeItem("accessToken"),localStorage.removeItem("refreshToken")}catch(e){}},k=new Set,E=f()(u(d(h((e,o)=>{return n=s({},g),a={user:(()=>{try{const e=localStorage.getItem("user");return e?JSON.parse(e):null}catch(e){return null}})(),accessToken:y(),refreshToken:m(),isAuthenticated:!!y(),login:r=>i(null,null,function*(){try{e(e=>{e.isLoading=!0,e.error=null});const{login:t}=yield c(()=>i(null,null,function*(){const{login:e}=yield import("./auth-BvxLhCGx.js");return{login:e}}),__vite__mapDeps([0,1,2,3,4])),n=yield t(r),{accessToken:a,refreshToken:l,member:s}=n;l?T(a,l):localStorage.setItem("accessToken",a),localStorage.setItem("user",JSON.stringify(s)),e(e=>{e.user=s,e.accessToken=a,e.refreshToken=l||null,e.isAuthenticated=!0,e.isLoading=!1,e.error=null}),o().emit({type:"LOGIN_SUCCESS",payload:{user:s}})}catch(t){const r=t instanceof Error?t.message:"Login failed. Please try again.";throw e(e=>{e.isLoading=!1,e.error=r}),o().emit({type:"LOGIN_FAILURE",payload:{error:r}}),t}}),register:r=>i(null,null,function*(){try{e(e=>{e.isLoading=!0,e.error=null});const{register:t}=yield c(()=>i(null,null,function*(){const{register:e}=yield import("./auth-BvxLhCGx.js");return{register:e}}),__vite__mapDeps([0,1,2,3,4])),o=yield t(r),{accessToken:n,refreshToken:a,member:l}=o;a?T(n,a):localStorage.setItem("accessToken",n),localStorage.setItem("user",JSON.stringify(l)),e(e=>{e.user=l,e.accessToken=n,e.refreshToken=a||null,e.isAuthenticated=!0,e.isLoading=!1,e.error=null})}catch(t){const r=t instanceof Error?t.message:"Registration failed. Please try again.";throw e(e=>{e.isLoading=!1,e.error=r}),t}}),logout:()=>i(null,null,function*(){try{const{logout:e}=yield c(()=>i(null,null,function*(){const{logout:e}=yield import("./auth-BvxLhCGx.js");return{logout:e}}),__vite__mapDeps([0,1,2,3,4]));yield e()}catch(r){}finally{p(),localStorage.removeItem("user"),e(e=>{e.user=null,e.accessToken=null,e.refreshToken=null,e.isAuthenticated=!1,e.isLoading=!1,e.error=null}),o().emit({type:"LOGOUT",payload:{}})}}),refreshTokens:()=>i(null,null,function*(){try{if(!o().refreshToken)throw new Error("No refresh token available.");const{validateToken:r}=yield c(()=>i(null,null,function*(){const{validateToken:e}=yield import("./auth-BvxLhCGx.js");return{validateToken:e}}),__vite__mapDeps([0,1,2,3,4]));if(!(yield r()))throw new Error("Token refresh failed.");const t=y(),n=m();t&&n&&(e(e=>{e.accessToken=t,e.refreshToken=n,e.isAuthenticated=!0,e.error=null}),o().emit({type:"TOKEN_REFRESH",payload:{accessToken:t}}))}catch(r){throw o().logout(),r}}),updateProfile:r=>i(null,null,function*(){try{e(e=>{e.isLoading=!0,e.error=null});const t=yield fetch("/api/auth/profile",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o().accessToken}`},body:JSON.stringify(r)});if(!t.ok)throw new Error("Profile update failed.");const n=yield t.json();localStorage.setItem("user",JSON.stringify(n)),e(e=>{e.user=n,e.isLoading=!1,e.error=null}),o().emit({type:"PROFILE_UPDATE",payload:{user:n}})}catch(t){const r=t instanceof Error?t.message:"Profile update failed. Please try again.";throw e(e=>{e.isLoading=!1,e.error=r}),t}}),changePassword:r=>i(null,null,function*(){try{if(e(e=>{e.isLoading=!0,e.error=null}),!(yield fetch("/api/auth/change-password",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o().accessToken}`},body:JSON.stringify(r)})).ok)throw new Error("Password change failed.");e(e=>{e.isLoading=!1,e.error=null})}catch(t){const r=t instanceof Error?t.message:"Password change failed. Please try again.";throw e(e=>{e.isLoading=!1,e.error=r}),t}}),refreshUser:()=>i(null,null,function*(){try{e(e=>{e.isLoading=!0});const r=yield fetch("/api/auth/profile",{headers:{Authorization:`Bearer ${o().accessToken}`}});if(!r.ok)throw new Error("Failed to fetch user information.");const t=yield r.json();localStorage.setItem("user",JSON.stringify(t)),e(e=>{e.user=t,e.isLoading=!1,e.error=null})}catch(r){const t=r instanceof Error?r.message:"Failed to fetch user information. Please try again.";throw e(e=>{e.isLoading=!1,e.error=t}),r}}),setTokens:(r,t)=>{T(r,t),e(e=>{e.accessToken=r,e.refreshToken=t,e.isAuthenticated=!0})},clearTokens:()=>{p(),localStorage.removeItem("user"),e(e=>{e.user=null,e.accessToken=null,e.refreshToken=null,e.isAuthenticated=!1})},validateToken:()=>i(null,null,function*(){try{if(!o().accessToken)return!1;const{validateToken:e}=yield c(()=>i(null,null,function*(){const{validateToken:e}=yield import("./auth-BvxLhCGx.js");return{validateToken:e}}),__vite__mapDeps([0,1,2,3,4]));return yield e()}catch(e){return!1}}),setLoading:r=>{e(e=>{e.isLoading=r})},setError:r=>{e(e=>{e.error=r})},clearError:()=>{e(e=>{e.error=null})},reset:()=>{p(),localStorage.removeItem("user"),e(()=>s({},g))},emit:e=>{k.forEach(r=>{try{r(e)}catch(t){}})},subscribe:e=>(k.add(e),()=>{k.delete(e)})},r(n,t(a));var n,a}),{name:"elderberry-auth",partialize:e=>({isAuthenticated:e.isAuthenticated})})));export{E as u};

const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/auth-DHbW6d-A.js","assets/http-client-9JY-woyA.js"])))=>i.map(i=>d[i]);
var e=Object.defineProperty,r=Object.defineProperties,t=Object.getOwnPropertyDescriptors,l=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,a=(r,t,l)=>t in r?e(r,t,{enumerable:!0,configurable:!0,writable:!0,value:l}):r[t]=l,c=(e,r)=>{for(var t in r||(r={}))n.call(r,t)&&a(e,t,r[t]);if(l)for(var t of l(r))o.call(r,t)&&a(e,t,r[t]);return e},i=(e,r,t)=>new Promise((l,n)=>{var o=e=>{try{c(t.next(e))}catch(r){n(r)}},a=e=>{try{c(t.throw(e))}catch(r){n(r)}},c=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,a);c((t=t.apply(e,r)).next())});import{_ as s}from"./index-BnHvVWTh.js";import{s as u,p as h,i as d}from"./state-management-DnGX11vy.js";import{c as f}from"./react-vendor-DjlEhPtN.js";const y={user:null,accessToken:null,refreshToken:null,isAuthenticated:!1,isLoading:!1,error:null},g=()=>{try{return localStorage.getItem("accessToken")}catch(e){return null}},T=()=>{try{return localStorage.getItem("refreshToken")}catch(e){return null}},p=(e,r)=>{try{localStorage.setItem("accessToken",e),localStorage.setItem("refreshToken",r)}catch(t){}},_=()=>{try{localStorage.removeItem("accessToken"),localStorage.removeItem("refreshToken")}catch(e){}},k=new Set,E=f()(u(h(d((e,l)=>{return n=c({},y),o={user:(()=>{try{const e=localStorage.getItem("user");return e?JSON.parse(e):null}catch(e){return null}})(),accessToken:g(),refreshToken:T(),isAuthenticated:!!g(),login:r=>i(null,null,function*(){try{e(e=>{e.isLoading=!0,e.error=null});const{login:t}=yield s(()=>i(null,null,function*(){const{login:e}=yield import("./auth-DHbW6d-A.js");return{login:e}}),__vite__mapDeps([0,1])),n=yield t(r),{accessToken:o,refreshToken:a,member:c}=n;a?p(o,a):localStorage.setItem("accessToken",o),localStorage.setItem("user",JSON.stringify(c)),e(e=>{e.user=c,e.accessToken=o,e.refreshToken=a||null,e.isAuthenticated=!0,e.isLoading=!1,e.error=null}),l().emit({type:"LOGIN_SUCCESS",payload:{user:c}})}catch(t){const r=t instanceof Error?t.message:"Login failed. Please try again.";throw e(e=>{e.isLoading=!1,e.error=r}),l().emit({type:"LOGIN_FAILURE",payload:{error:r}}),t}}),register:r=>i(null,null,function*(){try{e(e=>{e.isLoading=!0,e.error=null});const{register:t}=yield s(()=>i(null,null,function*(){const{register:e}=yield import("./auth-DHbW6d-A.js");return{register:e}}),__vite__mapDeps([0,1])),l=yield t(r),{accessToken:n,refreshToken:o,member:a}=l;o?p(n,o):localStorage.setItem("accessToken",n),localStorage.setItem("user",JSON.stringify(a)),e(e=>{e.user=a,e.accessToken=n,e.refreshToken=o||null,e.isAuthenticated=!0,e.isLoading=!1,e.error=null})}catch(t){const r=t instanceof Error?t.message:"Registration failed. Please try again.";throw e(e=>{e.isLoading=!1,e.error=r}),t}}),logout:()=>i(null,null,function*(){try{const{logout:e}=yield s(()=>i(null,null,function*(){const{logout:e}=yield import("./auth-DHbW6d-A.js");return{logout:e}}),__vite__mapDeps([0,1]));yield e()}catch(r){}finally{_(),localStorage.removeItem("user"),e(e=>{e.user=null,e.accessToken=null,e.refreshToken=null,e.isAuthenticated=!1,e.isLoading=!1,e.error=null}),l().emit({type:"LOGOUT",payload:{}})}}),refreshTokens:()=>i(null,null,function*(){try{if(!l().refreshToken)throw new Error("No refresh token available.");const{validateToken:r}=yield s(()=>i(null,null,function*(){const{validateToken:e}=yield import("./auth-DHbW6d-A.js");return{validateToken:e}}),__vite__mapDeps([0,1]));if(!(yield r()))throw new Error("Token refresh failed.");const t=g(),n=T();t&&n&&(e(e=>{e.accessToken=t,e.refreshToken=n,e.isAuthenticated=!0,e.error=null}),l().emit({type:"TOKEN_REFRESH",payload:{accessToken:t}}))}catch(r){throw l().logout(),r}}),updateProfile:r=>i(null,null,function*(){try{e(e=>{e.isLoading=!0,e.error=null});const t=yield fetch("/api/auth/profile",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l().accessToken}`},body:JSON.stringify(r)});if(!t.ok)throw new Error("Profile update failed.");const n=yield t.json();localStorage.setItem("user",JSON.stringify(n)),e(e=>{e.user=n,e.isLoading=!1,e.error=null}),l().emit({type:"PROFILE_UPDATE",payload:{user:n}})}catch(t){const r=t instanceof Error?t.message:"Profile update failed. Please try again.";throw e(e=>{e.isLoading=!1,e.error=r}),t}}),changePassword:r=>i(null,null,function*(){try{if(e(e=>{e.isLoading=!0,e.error=null}),!(yield fetch("/api/auth/change-password",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l().accessToken}`},body:JSON.stringify(r)})).ok)throw new Error("Password change failed.");e(e=>{e.isLoading=!1,e.error=null})}catch(t){const r=t instanceof Error?t.message:"Password change failed. Please try again.";throw e(e=>{e.isLoading=!1,e.error=r}),t}}),refreshUser:()=>i(null,null,function*(){try{e(e=>{e.isLoading=!0});const r=yield fetch("/api/auth/profile",{headers:{Authorization:`Bearer ${l().accessToken}`}});if(!r.ok)throw new Error("Failed to fetch user information.");const t=yield r.json();localStorage.setItem("user",JSON.stringify(t)),e(e=>{e.user=t,e.isLoading=!1,e.error=null})}catch(r){const t=r instanceof Error?r.message:"Failed to fetch user information. Please try again.";throw e(e=>{e.isLoading=!1,e.error=t}),r}}),setTokens:(r,t)=>{p(r,t),e(e=>{e.accessToken=r,e.refreshToken=t,e.isAuthenticated=!0})},clearTokens:()=>{_(),localStorage.removeItem("user"),e(e=>{e.user=null,e.accessToken=null,e.refreshToken=null,e.isAuthenticated=!1})},validateToken:()=>i(null,null,function*(){try{if(!l().accessToken)return!1;const{validateToken:e}=yield s(()=>i(null,null,function*(){const{validateToken:e}=yield import("./auth-DHbW6d-A.js");return{validateToken:e}}),__vite__mapDeps([0,1]));return yield e()}catch(e){return!1}}),setLoading:r=>{e(e=>{e.isLoading=r})},setError:r=>{e(e=>{e.error=r})},clearError:()=>{e(e=>{e.error=null})},reset:()=>{_(),localStorage.removeItem("user"),e(()=>c({},y))},emit:e=>{k.forEach(r=>{try{r(e)}catch(t){}})},subscribe:e=>(k.add(e),()=>{k.delete(e)})},r(n,t(o));var n,o}),{name:"elderberry-auth",partialize:e=>({isAuthenticated:e.isAuthenticated})})));export{E as u};

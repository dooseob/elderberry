name: ì—˜ë”ë² ë¦¬ CI/CD Pipeline

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master ]

env:
  JAVA_VERSION: '21'
  NODE_VERSION: '22'

jobs:
  # ==========================================
  # Phase 1: ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œ
  # ==========================================
  backend-test:
    runs-on: ubuntu-latest
    name: ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸ (Spring Boot + Java 21)
    
    steps:
    - name: ğŸ“¥ ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: â˜• Java 21 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    - name: ğŸ˜ Gradle ìºì‹œ ì„¤ì •
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: ğŸ”§ Gradle ê¶Œí•œ ì„¤ì •
      run: chmod +x ./gradlew
      
    - name: ğŸ§ª ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: ./gradlew test --no-daemon
      
    - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: backend-test-results
        path: build/reports/tests/test/
        
    - name: ğŸ“ˆ ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ì²´í¬
      run: ./gradlew jacocoTestReport --no-daemon
      
    - name: ğŸ—ï¸ ë°±ì—”ë“œ ë¹Œë“œ
      run: ./gradlew build -x test --no-daemon

  # ==========================================
  # Phase 2: í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œ
  # ==========================================
  frontend-test:
    runs-on: ubuntu-latest
    name: í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸ (React + TypeScript)
    
    steps:
    - name: ğŸ“¥ ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'frontend/package-lock.json'
        
    - name: ğŸ“¦ í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      working-directory: ./frontend
      run: npm ci --legacy-peer-deps
      
    - name: ğŸ” TypeScript íƒ€ì… ì²´í¬
      working-directory: ./frontend
      run: npm run type-check
      
    - name: ğŸ§¹ ESLint ì •ì  ë¶„ì„
      working-directory: ./frontend
      run: npm run lint
      
    - name: ğŸ§ª í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      working-directory: ./frontend
      run: npm run test:ci
      env:
        CI: true
        
    - name: ğŸ—ï¸ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
      working-directory: ./frontend
      run: npm run build
      
    - name: ğŸ“Š ë¹Œë“œ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: frontend/dist/

  # ==========================================
  # Phase 3: í†µí•© í…ŒìŠ¤íŠ¸ ë° Docker ë¹Œë“œ
  # ==========================================
  integration-test:
    runs-on: ubuntu-latest
    name: í†µí•© í…ŒìŠ¤íŠ¸ ë° Docker ë¹Œë“œ
    needs: [backend-test, frontend-test]
    
    steps:
    - name: ğŸ“¥ ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ³ Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ—ï¸ Docker Compose í…ŒìŠ¤íŠ¸ í™˜ê²½ êµ¬ì„±
      run: |
        cp docker-compose.dev.yml docker-compose.test.yml
        docker-compose -f docker-compose.test.yml up -d redis
        
    - name: â³ ì„œë¹„ìŠ¤ ì¤€ë¹„ ëŒ€ê¸°
      run: |
        echo "Redis ì„œë¹„ìŠ¤ ì¤€ë¹„ ì¤‘..."
        sleep 10
        
    - name: â˜• Java 21 ì„¤ì • (í†µí•© í…ŒìŠ¤íŠ¸ìš©)
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    - name: ğŸ§ª í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        chmod +x ./gradlew
        ./gradlew integrationTest --no-daemon
      env:
        SPRING_PROFILES_ACTIVE: test
        SPRING_REDIS_HOST: localhost
        SPRING_REDIS_PORT: 6379
        SPRING_REDIS_PASSWORD: elderberry123!
        
    - name: ğŸ—ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ í…ŒìŠ¤íŠ¸
      run: |
        docker build -t elderberry-backend:test .
        docker build -f frontend/Dockerfile.dev -t elderberry-frontend:test ./frontend
        
    - name: ğŸ§¹ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì •ë¦¬
      if: always()
      run: docker-compose -f docker-compose.test.yml down -v

  # ==========================================
  # Phase 4: ë°°í¬ ì¤€ë¹„ (master ë¸Œëœì¹˜ë§Œ)
  # ==========================================
  deploy-prep:
    runs-on: ubuntu-latest
    name: ë°°í¬ ì¤€ë¹„
    needs: [integration-test]
    if: github.ref == 'refs/heads/master'
    
    steps:
    - name: ğŸ“¥ ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ·ï¸ ë²„ì „ íƒœê·¸ ìƒì„±
      id: version
      run: |
        VERSION=$(date +%Y.%m.%d)-$(echo ${{ github.sha }} | cut -c1-7)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ·ï¸ Version: $VERSION"
        
    - name: ğŸ“ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¤€ë¹„
      run: |
        echo "## ğŸš€ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ - v${{ steps.version.outputs.version }}" > RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        echo "### âœ… ê²€ì¦ ì™„ë£Œ í•­ëª©" >> RELEASE_NOTES.md
        echo "- ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸ í†µê³¼" >> RELEASE_NOTES.md
        echo "- í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸ í†µê³¼" >> RELEASE_NOTES.md
        echo "- í†µí•© í…ŒìŠ¤íŠ¸ í†µê³¼" >> RELEASE_NOTES.md
        echo "- Docker ë¹Œë“œ ê²€ì¦ ì™„ë£Œ" >> RELEASE_NOTES.md
        
    - name: ğŸ“Š ë°°í¬ ì¤€ë¹„ ìƒíƒœ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: deployment-ready-v${{ steps.version.outputs.version }}
        path: |
          RELEASE_NOTES.md
          docker-compose.dev.yml

  # ==========================================
  # Phase 5: ì•Œë¦¼ ë° ê²°ê³¼ ë³´ê³ 
  # ==========================================
  notify:
    runs-on: ubuntu-latest
    name: ê²°ê³¼ ì•Œë¦¼
    needs: [backend-test, frontend-test, integration-test]
    if: always()
    
    steps:
    - name: ğŸ“Š ì „ì²´ ê²°ê³¼ ìš”ì•½
      run: |
        echo "## ğŸ¯ CI/CD íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ê²°ê³¼"
        echo "- ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸: ${{ needs.backend-test.result }}"
        echo "- í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸: ${{ needs.frontend-test.result }}"
        echo "- í†µí•© í…ŒìŠ¤íŠ¸: ${{ needs.integration-test.result }}"
        
        if [[ "${{ needs.backend-test.result }}" == "success" && 
              "${{ needs.frontend-test.result }}" == "success" && 
              "${{ needs.integration-test.result }}" == "success" ]]; then
          echo "ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼! ë°°í¬ ì¤€ë¹„ ì™„ë£Œ"
        else
          echo "âŒ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ - ì½”ë“œ ê²€í†  í•„ìš”"
        fi
     â˜’ Phase 5-A ë¡œê¹… ì‹œìŠ¤í…œ í™œìš© í™•ì¸ ë° ë¬¸ì„œí™”
     â˜ Phase 5-B: ì‹œì„¤ ë§¤ì¹­ ë° ì¶”ì²œ ì‹œìŠ¤í…œ êµ¬í˜„
     â˜ Phase 5-C: React ì‹œì„¤ ê²€ìƒ‰ UI êµ¬í˜„
     â˜ Phase 6-A: ê³µê³µë°ì´í„° API ì—°ë™ ê¸°ë³¸ êµ¬í˜„

â— ğŸš€ Phase 5-B: ì‹œì„¤ ë§¤ì¹­ ë° ì¶”ì²œ ì‹œìŠ¤í…œ ê³ ë„í™”

  Phase 5-Aì—ì„œ ê¸°ë³¸ ë§¤ì¹­ ì‹œìŠ¤í…œì„ êµ¬í˜„í–ˆìœ¼ë¯€ë¡œ, Phase 5-Bì—ì„œëŠ” AI ê¸°ë°˜ ì§€ëŠ¥í˜• ë§¤ì¹­, ì‹¤ì‹œê°„ ì¶”ì²œ ì‹œìŠ¤í…œ, ë§¤ì¹­ ì„±ê³¼ ì¶”ì  ê¸°ëŠ¥ì„ ì¶”ê°€ë¡œ
  êµ¬í˜„í•˜ê² ìŠµë‹ˆë‹¤.

  1ï¸âƒ£ ì§€ëŠ¥í˜• ë§¤ì¹­ ì„±ê³¼ ì¶”ì  ì‹œìŠ¤í…œ

â— Write(src/main/java/com/globalcarelink/facility/FacilityMatchingHistory.java)
  â¿  Wrote 222 lines to src/main/java/com/globalcarelink/facility/FacilityMatchingHistory.java
     package com.globalcarelink.facility;
     import com.globalcarelink.common.entity.BaseEntity;
     import jakarta.persistence.*;
     import jakarta.validation.constraints.*;
     import lombok.*;
     import java.math.BigDecimal;
     import java.time.LocalDateTime;
     â€¦ +212 lines (ctrl+r to expand)

â— 2ï¸âƒ£ ë§¤ì¹­ ì´ë ¥ ì €ì¥ì†Œ

â— Write(src/main/java/com/globalcarelink/facility/FacilityMatchingHistoryRepository.java)
  â¿  Wrote 237 lines to src/main/java/com/globalcarelink/facility/FacilityMatchingHistoryRepository.java
     package com.globalcarelink.facility;
     import org.springframework.data.domain.Page;
     import org.springframework.data.domain.Pageable;
     import org.springframework.data.jpa.repository.JpaRepository;
     import org.springframework.data.jpa.repository.Query;
     import org.springframework.data.repository.query.Param;
     import org.springframework.stereotype.Repository;
     import java.math.BigDecimal;
     â€¦ +227 lines (ctrl+r to expand)

â— 3ï¸âƒ£ ì§€ëŠ¥í˜• ë§¤ì¹­ ë¶„ì„ ì„œë¹„ìŠ¤

â— Write(src/main/java/com/globalcarelink/facility/FacilityMatchingAnalyticsService.java)
  â¿  Wrote 516 lines to src/main/java/com/globalcarelink/facility/FacilityMatchingAnalyticsService.java
     package com.globalcarelink.facility;
     import lombok.*;
     import lombok.extern.slf4j.Slf4j;
     import org.springframework.cache.annotation.Cacheable;
     import org.springframework.data.domain.Page;
     import org.springframework.data.domain.PageRequest;
     import org.springframework.scheduling.annotation.Async;
     import org.springframework.stereotype.Service;
     import org.springframework.transaction.annotation.Transactional;
     â€¦ +506 lines (ctrl+r to expand)

â— 4ï¸âƒ£ ê³ ë„í™”ëœ ë§¤ì¹­ ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸

â— Read(src/main/java/com/globalcarelink/facility/FacilityProfileService.java)
  â¿  Read 50 lines (ctrl+r to expand)

â— Update(src/main/java/com/globalcarelink/facility/FacilityProfileService.java)
  â¿  Updated src/main/java/com/globalcarelink/facility/FacilityProfileService.java with 1 addition
       30    public class FacilityProfileService {
       31    
       32        private final FacilityProfileRepository facilityProfileRepository;
       33 +      private final FacilityMatchingHistoryRepository matchingHistoryRepository;       
       34    
       35        // ===== ê¸°ë³¸ CRUD ì‘ì—… =====
       36    

â— Read(src/main/java/com/globalcarelink/facility/FacilityProfileService.java)
  â¿  Read 25 lines (ctrl+r to expand)

â— Read(src/main/java/com/globalcarelink/facility/FacilityProfileService.java)
  â¿  Read 50 lines (ctrl+r to expand)

â— Read(src/main/java/com/globalcarelink/facility/FacilityProfileService.java)
  â¿  Read 0 lines

â— Update(src/main/java/com/globalcarelink/facility/FacilityProfileService.java)
  â¿  Error: String to replace not found in file.
     String:         return Math.min(score, 5.0);
         }

         // ===== ê³µí†µ ìœ í‹¸ë¦¬í‹° ë©”ì„œë“œ =====

â— Read(src/main/java/com/globalcarelink/facility/FacilityProfileService.java)
  â¿  Read 26 lines (ctrl+r to expand)

â— Update(src/main/java/com/globalcarelink/facility/FacilityProfileService.java)
  â¿  Updated src/main/java/com/globalcarelink/facility/FacilityProfileService.java with 261 additions
        872            private final Map<String, Long> gradeStatistics;
        873            private final LocalDateTime lastUpdated;
        874        }
        875 +  
        876 +      // ===== ë§¤ì¹­ ì´ë ¥ ì¶”ì  =====
        877 +  
        878 +      /**
        879 +       * ë§¤ì¹­ ì¶”ì²œ ê²°ê³¼ë¥¼ ì´ë ¥ì— ì €ì¥
        880 +       */
        881 +      @Transactional
        882 +      public void recordMatchingRecommendations(String userId, String coordinatorId, 
        883 +                                              List<FacilityRecommendation> recommendations,
        884 +                                              HealthAssessment assessment, 
        885 +                                              FacilityMatchingPreference preference) {
        886 +          log.info("ë§¤ì¹­ ì¶”ì²œ ì´ë ¥ ì €ì¥ - ì‚¬ìš©ì: {}, ì¶”ì²œ ìˆ˜: {}", userId, recommendations.size());
        887 +
        888 +          for (int i = 0; i < recommendations.size(); i++) {
        889 +              FacilityRecommendation recommendation = recommendations.get(i);
        890 +
        891 +              FacilityMatchingHistory history = FacilityMatchingHistory.builder()
        892 +                  .userId(userId)
        893 +                  .facilityId(recommendation.getFacility().getId())
        894 +                  .coordinatorId(coordinatorId)
        895 +                  .initialMatchScore(BigDecimal.valueOf(recommendation.getMatchScore()).setScale(2, 
            + java.math.RoundingMode.HALF_UP))
        896 +                  .recommendationRank(i + 1)
        897 +                  .matchingCriteria(serializeMatchingCriteria(assessment, preference))
        898 +                  .facilitySnapshot(serializeFacilitySnapshot(recommendation.getFacility()))
        899 +                  .estimatedCost(calculateEstimatedMonthlyCost(recommendation.getFacility(), assessment))
        900 +                  .build();
        901 +
        902 +              matchingHistoryRepository.save(history);
        903 +          }
        904 +
        905 +          log.info("ë§¤ì¹­ ì¶”ì²œ ì´ë ¥ ì €ì¥ ì™„ë£Œ - {} ê±´", recommendations.size());
        906 +      }
        907 +  
        908 +      /**
        909 +       * ì‚¬ìš©ì í–‰ë™ ì¶”ì  - ì‹œì„¤ ì¡°íšŒ
        910 +       */
        911 +      @Transactional
        912 +      public void trackFacilityView(String userId, Long facilityId) {
        913 +          Optional<FacilityMatchingHistory> historyOpt = 
        914 +              matchingHistoryRepository.findTopByUserIdAndFacilityIdOrderByCreatedAtDesc(userId, facilityId);
        915 +
        916 +          if (historyOpt.isPresent()) {
        917 +              FacilityMatchingHistory history = historyOpt.get();
        918 +              history.markAsViewed();
        919 +              matchingHistoryRepository.save(history);
        920 +
        921 +              log.info("ì‹œì„¤ ì¡°íšŒ ì¶”ì  ì™„ë£Œ - ì‚¬ìš©ì: {}, ì‹œì„¤: {}", userId, facilityId);
        922 +          }
        923 +      }
        924 +  
        925 +      /**
        926 +       * ì‚¬ìš©ì í–‰ë™ ì¶”ì  - ì‹œì„¤ ì—°ë½
        927 +       */
        928 +      @Transactional
        929 +      public void trackFacilityContact(String userId, Long facilityId) {
        930 +          Optional<FacilityMatchingHistory> historyOpt = 
        931 +              matchingHistoryRepository.findTopByUserIdAndFacilityIdOrderByCreatedAtDesc(userId, facilityId);
        932 +
        933 +          if (historyOpt.isPresent()) {
        934 +              FacilityMatchingHistory history = historyOpt.get();
        935 +              history.markAsContracted();
        936 +              matchingHistoryRepository.save(history);
        937 +
        938 +              log.info("ì‹œì„¤ ì—°ë½ ì¶”ì  ì™„ë£Œ - ì‚¬ìš©ì: {}, ì‹œì„¤: {}", userId, facilityId);
        939 +          }
        940 +      }
        941 +  
        942 +      /**
        943 +       * ì‚¬ìš©ì í–‰ë™ ì¶”ì  - ì‹œì„¤ ë°©ë¬¸
        944 +       */
        945 +      @Transactional
        946 +      public void trackFacilityVisit(String userId, Long facilityId) {
        947 +          Optional<FacilityMatchingHistory> historyOpt = 
        948 +              matchingHistoryRepository.findTopByUserIdAndFacilityIdOrderByCreatedAtDesc(userId, facilityId);
        949 +
        950 +          if (historyOpt.isPresent()) {
        951 +              FacilityMatchingHistory history = historyOpt.get();
        952 +              history.markAsVisited();
        953 +              matchingHistoryRepository.save(history);
        954 +
        955 +              log.info("ì‹œì„¤ ë°©ë¬¸ ì¶”ì  ì™„ë£Œ - ì‚¬ìš©ì: {}, ì‹œì„¤: {}", userId, facilityId);
        956 +          }
        957 +      }
        958 +  
        959 +      /**
        960 +       * ë§¤ì¹­ ì™„ë£Œ ì²˜ë¦¬
        961 +       */
        962 +      @Transactional
        963 +      public void completeMatching(String userId, Long facilityId, 
        964 +                                 FacilityMatchingHistory.MatchingOutcome outcome,
        965 +                                 BigDecimal actualCost, BigDecimal satisfactionScore, String feedback) {
        966 +          Optional<FacilityMatchingHistory> historyOpt = 
        967 +              matchingHistoryRepository.findTopByUserIdAndFacilityIdOrderByCreatedAtDesc(userId, facilityId);
        968 +
        969 +          if (historyOpt.isPresent()) {
        970 +              FacilityMatchingHistory history = historyOpt.get();
        971 +              history.markAsSelected(outcome);
        972 +
        973 +              if (actualCost != null) {
        974 +                  history.setActualCost(actualCost);
        975 +              }
        976 +
        977 +              if (satisfactionScore != null) {
        978 +                  history.updateFeedback(satisfactionScore, feedback);
        979 +              }
        980 +
        981 +              matchingHistoryRepository.save(history);
        982 +
        983 +              log.info("ë§¤ì¹­ ì™„ë£Œ ì²˜ë¦¬ - ì‚¬ìš©ì: {}, ì‹œì„¤: {}, ê²°ê³¼: {}", userId, facilityId, outcome);
        984 +          }
        985 +      }
        986 +  
        987 +      /**
        988 +       * í•™ìŠµ ê¸°ë°˜ ë§¤ì¹­ ì ìˆ˜ ì¡°ì •
        989 +       */
        990 +      public List<FacilityRecommendation> adjustMatchingScoresWithLearning(List<FacilityRecommendation> recommendations,       
        991 +                                                                          String userId) {
        992 +          // ì‚¬ìš©ìì˜ ê³¼ê±° ë§¤ì¹­ ì´ë ¥ì„ ê¸°ë°˜ìœ¼ë¡œ ì ìˆ˜ ì¡°ì •
        993 +          List<FacilityMatchingHistory> userHistory = 
        994 +              matchingHistoryRepository.findByUserIdOrderByCreatedAtDesc(userId);
        995 +
        996 +          if (userHistory.isEmpty()) {
        997 +              return recommendations; // ì´ë ¥ì´ ì—†ìœ¼ë©´ ì›ë³¸ ê·¸ëŒ€ë¡œ ë°˜í™˜
        998 +          }
        999 +
       1000 +          // ì„±ê³µí•œ ë§¤ì¹­ë“¤ì˜ íŒ¨í„´ ë¶„ì„
       1001 +          List<FacilityMatchingHistory> successfulMatches = userHistory.stream()
       1002 +              .filter(FacilityMatchingHistory::isSuccessfulMatch)
       1003 +              .collect(Collectors.toList());
       1004 +
       1005 +          if (successfulMatches.isEmpty()) {
       1006 +              return recommendations;
       1007 +          }
       1008 +
       1009 +          // ì„ í˜¸ íŒ¨í„´ ì¶”ì¶œ
       1010 +          Map<String, Double> facilityTypePreference = extractFacilityTypePreference(successfulMatches);
       1011 +          Map<String, Double> facilityGradePreference = extractFacilityGradePreference(successfulMatches);
       1012 +          double avgSuccessfulCost = calculateAverageSuccessfulCost(successfulMatches);
       1013 +
       1014 +          // ì¶”ì²œ ì ìˆ˜ ì¡°ì •
       1015 +          return recommendations.stream()
       1016 +              .map(rec -> adjustRecommendationScore(rec, facilityTypePreference, facilityGradePreference, 
            + avgSuccessfulCost))
       1017 +              .sorted(Comparator.comparing(FacilityRecommendation::getMatchScore).reversed())
       1018 +              .collect(Collectors.toList());
       1019 +      }
       1020 +  
       1021 +      // ===== í•™ìŠµ ê¸°ë°˜ ìœ í‹¸ë¦¬í‹° ë©”ì„œë“œ =====
       1022 +  
       1023 +      private String serializeMatchingCriteria(HealthAssessment assessment, FacilityMatchingPreference preference) {
       1024 +          return String.format("{\"careGrade\":%d,\"regions\":%s,\"maxFee\":%d}", 
       1025 +              assessment.getCareGradeLevel(),
       1026 +              preference.getPreferredRegions().toString(),
       1027 +              preference.getMaxMonthlyFee() != null ? preference.getMaxMonthlyFee() : 0);
       1028 +      }
       1029 +  
       1030 +      private String serializeFacilitySnapshot(FacilityProfile facility) {
       1031 +          return String.format("{\"type\":\"%s\",\"grade\":\"%s\",\"capacity\":%d,\"monthlyFee\":%d}",
       1032 +              facility.getFacilityType(),
       1033 +              facility.getFacilityGrade(),
       1034 +              facility.getTotalCapacity(),
       1035 +              facility.getMonthlyBasicFee() != null ? facility.getMonthlyBasicFee() : 0);
       1036 +      }
       1037 +  
       1038 +      private BigDecimal calculateEstimatedMonthlyCost(FacilityProfile facility, HealthAssessment assessment) {
       1039 +          Integer basicFee = facility.getMonthlyBasicFee();
       1040 +          if (basicFee == null) return null;
       1041 +
       1042 +          double multiplier = 1.0;
       1043 +
       1044 +          // ì¼€ì–´ ë“±ê¸‰ì— ë”°ë¥¸ ë¹„ìš© ì¡°ì •
       1045 +          if (assessment.getCareGradeLevel() <= 2) {
       1046 +              multiplier += 0.3; // ì¤‘ì¦ ì¼€ì–´ 30% ì¶”ê°€
       1047 +          } else if (assessment.getCareGradeLevel() <= 3) {
       1048 +              multiplier += 0.15; // ì¤‘ë“±ë„ ì¼€ì–´ 15% ì¶”ê°€
       1049 +          }
       1050 +
       1051 +          return BigDecimal.valueOf(basicFee * multiplier).setScale(0, java.math.RoundingMode.HALF_UP);
       1052 +      }
       1053 +  
       1054 +      private Map<String, Double> extractFacilityTypePreference(List<FacilityMatchingHistory> successfulMatches) {
       1055 +          Map<String, Double> preferences = new HashMap<>();
       1056 +
       1057 +          successfulMatches.forEach(match -> {
       1058 +              // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì‹œì„¤ ì •ë³´ë¥¼ ì¡°íšŒí•˜ì—¬ íƒ€ì…ì„ í™•ì¸
       1059 +              // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ ì²˜ë¦¬
       1060 +              Optional<FacilityProfile> facility = facilityProfileRepository.findById(match.getFacilityId());
       1061 +              if (facility.isPresent()) {
       1062 +                  String type = facility.get().getFacilityType();
       1063 +                  preferences.merge(type, 1.0, Double::sum);
       1064 +              }
       1065 +          });
       1066 +
       1067 +          // ì •ê·œí™”
       1068 +          double total = preferences.values().stream().mapToDouble(Double::doubleValue).sum();
       1069 +          if (total > 0) {
       1070 +              preferences.replaceAll((k, v) -> v / total);
       1071 +          }
       1072 +
       1073 +          return preferences;
       1074 +      }
       1075 +  
       1076 +      private Map<String, Double> extractFacilityGradePreference(List<FacilityMatchingHistory> successfulMatches) {
       1077 +          Map<String, Double> preferences = new HashMap<>();
       1078 +
       1079 +          successfulMatches.forEach(match -> {
       1080 +              Optional<FacilityProfile> facility = facilityProfileRepository.findById(match.getFacilityId());
       1081 +              if (facility.isPresent()) {
       1082 +                  String grade = facility.get().getFacilityGrade();
       1083 +                  preferences.merge(grade, 1.0, Double::sum);
       1084 +              }
       1085 +          });
       1086 +
       1087 +          // ì •ê·œí™”
       1088 +          double total = preferences.values().stream().mapToDouble(Double::doubleValue).sum();
       1089 +          if (total > 0) {
       1090 +              preferences.replaceAll((k, v) -> v / total);
       1091 +          }
       1092 +
       1093 +          return preferences;
       1094 +      }
       1095 +  
       1096 +      private double calculateAverageSuccessfulCost(List<FacilityMatchingHistory> successfulMatches) {
       1097 +          return successfulMatches.stream()
       1098 +              .filter(match -> match.getActualCost() != null)
       1099 +              .mapToDouble(match -> match.getActualCost().doubleValue())
       1100 +              .average()
       1101 +              .orElse(0.0);
       1102 +      }
       1103 +  
       1104 +      private FacilityRecommendation adjustRecommendationScore(FacilityRecommendation recommendation,
       1105 +                                                             Map<String, Double> typePreference,
       1106 +                                                             Map<String, Double> gradePreference,
       1107 +                                                             double avgSuccessfulCost) {
       1108 +          double currentScore = recommendation.getMatchScore();
       1109 +          double adjustmentFactor = 1.0;
       1110 +
       1111 +          FacilityProfile facility = recommendation.getFacility();
       1112 +
       1113 +          // ì‹œì„¤ íƒ€ì… ì„ í˜¸ë„ ë°˜ì˜
       1114 +          Double typeBonus = typePreference.get(facility.getFacilityType());
       1115 +          if (typeBonus != null) {
       1116 +              adjustmentFactor += typeBonus * 0.2; // ìµœëŒ€ 20% ê°€ì‚°
       1117 +          }
       1118 +
       1119 +          // ì‹œì„¤ ë“±ê¸‰ ì„ í˜¸ë„ ë°˜ì˜
       1120 +          Double gradeBonus = gradePreference.get(facility.getFacilityGrade());
       1121 +          if (gradeBonus != null) {
       1122 +              adjustmentFactor += gradeBonus * 0.15; // ìµœëŒ€ 15% ê°€ì‚°
       1123 +          }
       1124 +
       1125 +          // ë¹„ìš© ìœ ì‚¬ì„± ë°˜ì˜
       1126 +          if (avgSuccessfulCost > 0 && facility.getMonthlyBasicFee() != null) {
       1127 +              double costSimilarity = 1.0 - Math.abs(facility.getMonthlyBasicFee() - avgSuccessfulCost) / 
            + avgSuccessfulCost;
       1128 +              adjustmentFactor += Math.max(0, costSimilarity) * 0.1; // ìµœëŒ€ 10% ê°€ì‚°
       1129 +          }
       1130 +
       1131 +          double adjustedScore = Math.min(currentScore * adjustmentFactor, 100.0);
       1132 +
       1133 +          return new FacilityRecommendation(facility, adjustedScore, 
       1134 +              recommendation.getRecommendationReason() + " (í•™ìŠµ ê¸°ë°˜ ì¡°ì • ì ìš©)");
       1135 +      }
       1136    }
       1137   \ No newline at end of file